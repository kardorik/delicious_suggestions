<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Produced by ODM to XHTML converter 20_03_08, Fri Mar 21 17:56:17 +0100 2008 -->

<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='content-type' />
    <link href='http://www.jhl.it/jhl.atom' title='Atom 1.0 feed' rel='alternate' type='application/atom+xml' />
    <script type='text/javascript' src='http://www.google-analytics.com/ga.js'>
      <!-- // bug fix -->
    </script>
    <title>Ruby and Ajax</title>
    <link href='../Css/jhl.css' rel='stylesheet' type='text/css' />
    <link href='../Css/Standard.css' rel='stylesheet' type='text/css' />
    <style type='text/css'>
      <!--

.T1 {
	font-size: 58%;
	vertical-align: super;
}

.fr1 {
	clear: both;
	margin-bottom: 0cm;
	margin-left: 0cm;
	margin-right: 0cm;
	margin-top: 0cm;
}

-->
    </style>
  </head>
  <body>
    <div align='center'>
      <div id='header'>
        <div class='header-inner'><a href='http://www.syger.it/'><img title='My software company...' src='../Images/syger.png' height='81' alt='My software company...' style='border: 0;' width='150' /></a><span>John Leach</span><a href='http://www.syger.org/'><img title='The Pragmatic Computer User&#39;s Guide Project...' src='../Images/pcug.png' height='70' alt='The Pragmatic Computer User&#39;s Guide Project...' style='border: 0;' width='250' /></a></div>
      </div>
      <div id='page'>
        <div id='centercol'>
          <h3 class='Heading_20_3'>Ruby and Ajax</h3>
          <div class='Text_20_body'>LUG Programming Course, 25<span class='T1'>th</span> February 2008</div>
          <div class='Text_20_body'>After our brief, but intense, first look at Ruby, we can start using this excellent scripting language to create our first web application. We previously used the Prototype and script.aculo.us libraries to dynamically modify an XHTML page, now we&#39;ll use Ajax via the script.aculo.us <a href='http://wiki.script.aculo.us/scriptaculous/show/Ajax.Autocompleter'><span class='Source_20_Text'>Ajax.Autocompleter</span></a> to &#39;talk&#39; to a simple Ruby web application.</div>
          <div class='Text_20_body'>This lesson will introduce you to <a href='http://www.webrick.org/'><span class='Internet_20_Hyperlink'>WEBrick</span></a>, the Ruby web server, <a href='http://www.w3.org/TR/html4/interact/forms.html'><span class='Internet_20_Hyperlink'>HTML forms</span></a>, the <a href='http://www.ruby-doc.org/stdlib/libdoc/erb/rdoc/classes/ERB.html'><span class='Internet_20_Hyperlink'>ERB</span></a> templating system, and <a href='http://en.wikipedia.org/wiki/AJAX'><span class='Internet_20_Hyperlink'>Ajax</span></a>.</div>
          <div class='Text_20_body'>Despite the amount of code involved, the lesson went quite quickly, and I managed to finish with about twenty minutes to spare. We used that time to go over some of the Ruby code again. Everyone seemed to enjoy the results of running their first web application. One student even started adding his own text files, which I found gratifying, because that was what the application was designed for – any number of plain text files.</div>
          <h4 class='Heading_20_4'>The Word Search Web Application</h4>
          <div class='Text_20_body'>Well don&#39;t get too excited, this isn&#39;t going to get Google worried. Our objective in this lesson is to use the <span class='Source_20_Text'>WordCount</span> class from the previous lesson so that the user can type a word, and then choose one of the text files that contains that word.</div>
          <div class='Text_20_body'>To make things a little more interesting, we want the results list to show the title and word count for each text file, we want to use Ajax to reduce the bandwidth to the server and increase responsiveness, and we also want to fall back to traditional <a href='http://www.w3.org/Protocols/rfc2616/rfc2616.html'><span class='Internet_20_Hyperlink'>HTTP</span></a> requests and responses if JavaScript is not available.</div>
          <h5 class='Heading_20_5'>A Little Architecture</h5>
          <div class='Text_20_body'>Before we dive into the code, we&#39;ll have to spend a little time thinking about how we want to accomplish this task.</div>
          <div class='Text_20_body'>Obviously we need to learn how to use the <a href='http://wiki.script.aculo.us/scriptaculous/show/Ajax.Autocompleter'><span class='Source_20_Text'>Ajax.Autocompleter</span></a> class in script.aculo.us. There is an example in the <span class='Source_20_Text'>/tests/functional/</span> folder of the downloaded code, called<span class='Source_20_Text'> ajax_autocompleter.html</span>.</div>
          <div class='Text_20_body'>Further we&#39;ll need to write some Ruby to create our server application. This means we&#39;ll need to learn a little about the WEBrick server, and Ruby&#39;s templating system, called ERB. For a brief overview of WEBrick, there&#39;s the <a href='http://microjet.ath.cx/webrickguide/html/'><span class='Internet_20_Hyperlink'>Gnome&#39;s Guide to WEBrick</span></a>, by Yohanes Santoso. The <a href='http://www.ruby-doc.org/stdlib/libdoc/erb/rdoc/classes/ERB.html'><span class='Internet_20_Hyperlink'>class documentation</span></a> provides plenty of examples for ERB.</div>
          <div class='Text_20_body'>Finally, our two paragraph specifications require a little more from our <span class='Source_20_Text'>WordCount</span> class than it currently handles – we need the count for a specific word. The <span class='Source_20_Text'>WordCount</span> class has this information, it&#39;s just that there&#39;s no method to get at it. We&#39;ll also need a class that parses all five text files, and which effectively becomes the search engine, and a class for the results.</div>
          <div class='Text_20_body'>Before we start our project, let&#39;s take a look at the folder layout:</div>
          <pre class='Preformatted_20_Text'>app/
public/
  scripts/
  styles/
  text/</pre>
          <div class='Text_20_body'>This is a little more complicated than our previous examples. We&#39;ve added an <span class='Source_20_Text'>app/</span> folder which contains our Ruby code. Under the <span class='Source_20_Text'>public/</span> folder we&#39;ve added a sub-folder <span class='Source_20_Text'>text/</span> containing the text files. Why go to all this trouble? The reason is security. We don&#39;t want a user to have access to our web application script files, only to the public static files, or to the results that our application sends back. Although our application will only be run <a href='http://en.wikipedia.org/wiki/Localhost'><span class='Internet_20_Hyperlink'>localhost</span></a> (this is to say, on our own computer), I&#39;m trying to get you into the habit of keeping security in mind – it&#39;s a big bad world out there.</div>
          <h5 class='Heading_20_5'>The Search Classes</h5>
          <div class='Text_20_body'>We&#39;ll build our web application in two files, one for the server (<span class='Source_20_Text'>server.rb</span>), and one for the search classes (<span class='Source_20_Text'>search.rb</span>). Of course, we&#39;ll also be using our <span class='Source_20_Text'>word_count.rb</span> file from the last lesson, which we&#39;ll copy into the <span class='Source_20_Text'>app/</span> folder.</div>
          <div class='Text_20_body'>As always, you can download the source code for this lesson, via the link given at the end of this discussion. First then, let&#39;s take a look at our &#39;search engine&#39; in <span class='Source_20_Text'>search.rb</span>.</div>
          <pre class='Preformatted_20_Text'>01 require &#39;pathname&#39;
02 require &#39;word_count&#39;
03
04 # Add a method to our existing class
05 class WordCount
06
07   attr_accessor :url
08
09   # Return the count for a specific word
10   def word_count(word)
11     (count = @word_hash[word]) ? count : 0
12   end
13 end
14</pre>
          <div class='Text_20_body'>We need to add a couple of methods to our original <span class='Source_20_Text'>WordCount</span> class. Since Ruby is a dynamic language, it allows us to reopen existing class definitions (including built-in classes like <span class='Source_20_Text'>String</span>), and make the necessary changes. Since these changes are specifically for this application, we prefer not to change the original code.</div>
          <div class='Text_20_body'>Lines 1 and 2 use the <a href='http://ruby-doc.org/core/classes/Kernel.html'><span class='Source_20_Text'>Kernel</span></a><span class='Source_20_Text'>.require</span> method to load external scripts into memory. We&#39;ll see this in more detail in our server application code.</div>
          <div class='Text_20_body'>Line 7 adds a (read and write) accessor method for the <span class='Source_20_Text'>url</span> of the text file. We&#39;ll need this, because the URL is different from the file path we use to parse the file.</div>
          <div class='Text_20_body'>Lines 10 to 12 adds a new method <span class='Source_20_Text'>word_count</span> which returns the word count for a specified <span class='Source_20_Text'>word</span>. The ternary operator is used to ensure that a numeric value of <span class='Source_20_Text'>0</span> is returned when the <span class='Source_20_Text'>@word_hash</span> does not contain the word.</div>
          <pre class='Preformatted_20_Text'>15 # Holds the result of a word search
16 class Result
17
18   attr_reader :url, :title, :count
19
20   def initialize(wc, count)
21     @url = wc.url
22     @title = wc.title
23     @count = count
24   end
25
26   # Compare two results for ordering
27   def &lt;=&gt;(other)
28     return @title &lt;=&gt; other.title if @count == other.count
29     other.count &lt;=&gt; @count
30   end
31 end
32</pre>
          <div class='Text_20_body'>Next comes the <span class='Source_20_Text'>Result</span> class. It&#39;s job is to contain the result for each word found, that is to say the URL, title, and word count.</div>
          <div class='Text_20_body'>Lines 27 to 30 define the comparison operator for this class. Ruby, different to JavaScript, allows for <a href='http://en.wikipedia.org/wiki/Operator_overloading'><span class='Internet_20_Hyperlink'>operator overloading</span></a>. The &lt;=&gt; method (the comparison or &#39;spaceship&#39; method) is used, among other things, by <span class='Source_20_Text'>Array.sort</span>. We can overload this operator to order our results by highest word count (line 29), or by title when the word counts are identical (line 28).</div>
          <pre class='Preformatted_20_Text'>33 # The search engine
34 class SearchEngine
35
36   attr_reader :files
37
38   def initialize(path, remove, add)
39     @files = []
40     path = Pathname.new(path)
41     path.each_entry do |file|
42       file = path + file
43       if file.file? &amp;&amp; file.readable?
44         url = file.to_s
45         wc = WordCount.new(url, WordCount::MIN)
46         wc.parse
47         wc.url = url.index(remove) == 0 ? add + url[remove.length..-1] : url
48         @files &lt;&lt; wc
49       end
50     end
51   end
52</pre>
          <div class='Text_20_body'>The search engine has two important jobs. First it has to parse all the text files, then it has to produce results for a specified word. Lines 38 to 51 take care of the file parsing. To do that we make heavy use of the <a href='http://ruby-doc.org/core/classes/Pathname.html'><span class='Source_20_Text'>Pathname</span></a> class, as well as our modified <span class='Source_20_Text'>WordCount</span> class.</div>
          <div class='Text_20_body'>We check every file in the path (line 41), accepting readable files (line 43), which we put into a <span class='Source_20_Text'>WordCount</span> instance and parse (lines 45 and 46), and then add to the <span class='Source_20_Text'>@files</span> array (line 48). Line 47 massages the file path into the correct web application URL, removing the <span class='Source_20_Text'>remove</span> string from the start of the URL, and suffixing the <span class='Source_20_Text'>add</span> string. Using a range and array notation in a <span class='Source_20_Text'>String</span>, such as <span class='Source_20_Text'>url[remove.length..-1]</span>, is the Ruby equivalent of the JavaScript <span class='Source_20_Text'>substring</span> method. </div>
          <pre class='Preformatted_20_Text'>53   # Return an array of the matching results
54   def search(word)
55     results = []
56     if word.length &gt; 0
57       @files.each do |wc|
58         count = wc.word_count(word)
59         results &lt;&lt; Result.new(wc, count) if count &gt; 0
60       end
61     end
62     results.sort
63   end
64 end</pre>
          <div class='Text_20_body'>The <span class='Source_20_Text'>search</span> method produces an array of <span class='Source_20_Text'>Result</span> instances for the specified <span class='Source_20_Text'>word</span>. Line 57 to 60 retrieve the word <span class='Source_20_Text'>count</span> for each file parsed (as long as the word is not the empty string, tested on line 56). If the word <span class='Source_20_Text'>count</span> is greater than <span class='Source_20_Text'>0</span>, then we create a new <span class='Source_20_Text'>Result</span> object, and add it to the array (line 59).</div>
          <div class='Text_20_body'>The array is then sorted and returned to the caller (line 62).</div>
          <h5 class='Heading_20_5'>The Server Application</h5>
          <div class='Text_20_body'>With our helper classes in place, we can now look at the server application itself, <span class='Source_20_Text'>server.rb</span>.</div>
          <pre class='Preformatted_20_Text'>01 #!/usr/local/bin/ruby -w
02
03 require &#39;erb&#39;
04 require &#39;webrick&#39;
05 require &#39;search&#39;
06</pre>
          <div class='Text_20_body'>While our program has immediate access to all the built-in classes of Ruby, we frequently need to use other library code stored in external files. Ruby provides a mechanism for loading external files, which may be Ruby code or compiled binary libraries, via the <a href='http://www.ruby-doc.org/core/classes/Kernel.html'><span class='Source_20_Text'>Kernel</span></a><span class='Source_20_Text'>.require</span> method. If you leave off the extension, Ruby will search its library paths first for files with the <span class='Source_20_Text'>.rb</span> extension, then binary files with <span class='Source_20_Text'>.so</span> or <span class='Source_20_Text'>.dll</span> extensions. It is normal Ruby practice to leave off the extension. The application&#39;s directory also forms part of the paths that Ruby searches for external files, which means that we can also easily include our own code, on line 5.</div>
          <pre class='Preformatted_20_Text'>07 # The Search Web Application
08 class SearchServer &lt; WEBrick::HTTPServer
09
10   def initialize(config = {})
11     super(config)
12</pre>
          <div class='Text_20_body'>We&#39;ll create a <span class='Source_20_Text'>SearchServer</span> class based on the <span class='Source_20_Text'>WEBrick::HTTPServer</span> class. We&#39;ll leave WEBrick to do most of the hard work, but we still need our own <span class='Source_20_Text'>initialize</span> method. Here we simply use more or less the same parameters as the super class, and then call the super class <span class='Source_20_Text'>initialize</span> method, on line 11.</div>
          <div class='Text_20_body'>Now that we have initialised the super class, we can get on with our own initialisation.</div>
          <pre class='Preformatted_20_Text'>13     # HTML template
14     @html = ERB.new &lt;&lt;-xXx
15 &lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
16 &lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39;&gt;
17   &lt;head&gt;
18     &lt;meta http-equiv=&quot;Content-Type&quot; content=&#39;text/html; charset=UTF-8&#39; /&gt;
19     &lt;link rel=&quot;stylesheet&quot; href=&quot;/styles/search.css&quot; type=&quot;text/css&quot; media=&quot;screen&quot; charset=&quot;utf-8&quot; /&gt;
20     &lt;script src=&quot;/scripts/prototype.js&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
21     &lt;script src=&quot;/scripts/effects.js&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
22     &lt;script src=&quot;/scripts/controls.js&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
23     &lt;script src=&quot;/scripts/search.js&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
24     &lt;title&gt;LUG Programming Course, Lesson 7&lt;/title&gt;
25   &lt;/head&gt;
26   &lt;body&gt;
27     &lt;p class=&#39;title&#39;&gt;Example of Ruby and Ajax&lt;/p&gt;
28     &lt;form id=&#39;searchForm&#39; action=&#39;/search&#39;&gt;
29       &lt;p class=&#39;search&#39;&gt;
30         &lt;label for=&quot;search&quot;&gt;Search word:&lt;/label&gt;
31         &lt;input type=&quot;text&quot; id=&quot;search&quot; name=&quot;search&quot; maxlength=&#39;20&#39; value=&#39;&lt;%= word %&gt;&#39; /&gt;
32       &lt;/p&gt;
33       &lt;div id=&quot;results&quot; class=&quot;autocomplete&quot; style=&quot;display: block;&quot;&gt;
34         &lt;p&gt;Results:&lt;/p&gt;
35         &lt;%= links %&gt;
36       &lt;/div&gt;
37     &lt;/form&gt;
38   &lt;/body&gt;
39 &lt;/html&gt;
40 xXx
41</pre>
          <div class='Text_20_body'>Lines 14 to 40 creates our first template. This is practically identical to the normal static XHTML file contents, except for lines 31 and 35. There we have used the ERB expression delimiters <span class='Source_20_Text'>&lt;%= ... %&gt;</span>, to inject two Ruby variables, <span class='Source_20_Text'>word</span> and <span class='Source_20_Text'>links</span>. The first will contain the word submitted by the form, and the second will contain the results of the word search.</div>
          <div class='Text_20_body'>Another novelty are the <span class='Source_20_Text'>&lt;form&gt;</span> and <span class='Source_20_Text'>&lt;input&gt;</span> elements (lines 28 and 31). The <span class='Source_20_Text'>&lt;form&gt;</span> element defines or contains all of the <span class='Source_20_Text'>&lt;input&gt;</span> elements which make up a parameterised request. When the form is submitted to the URL defined by <span class='Source_20_Text'>action</span>, the parameters are sent to the server as name-value pairs.</div>
          <pre class='Preformatted_20_Text'>42     # HTML/Ajax template
43     @ajax = ERB.new &lt;&lt;-xXx
44 &lt;ul&gt;
45 &lt;% results.each do |r| %&gt;
46   &lt;li&gt;&lt;a href=&#39;&lt;%= r.url %&gt;&#39; type=&#39;text/plain&#39;&gt;&lt;%= r.title %&gt; (&lt;%= r.count %&gt;)&lt;/a&gt;&lt;/li&gt;
47 &lt;% end %&gt;
48 &lt;% if results.length == 0 &amp;&amp; is_html %&gt;
49   &lt;li&gt;No matches found, sorry.&lt;/li&gt;
50 &lt;% end %&gt;
51 &lt;/ul&gt;
52 xXx
53</pre>
          <div class='Text_20_body'>This is the second, and more complex template in our application. The <span class='Source_20_Text'>&lt;% ... %&gt;</span> delimiters allow us to add Ruby statements inside the template. Lines 45 to 47 produce <span class='Source_20_Text'>&lt;li&gt;</span> elements for each of the <span class='Source_20_Text'>Result</span> objects. Lines 48 to 50 add a <span class='Source_20_Text'>&lt;li&gt;</span> element explaining that no matches were found, though this only happens if there are no results and the <span class='Source_20_Text'>is_html</span> flag is <span class='Source_20_Text'>true</span>.</div>
          <div class='Text_20_body'>In fact, we&#39;ll use this template both for the Ajax responses and for the HTML form submission responses. In the first case, we don&#39;t need to make any apologies, as the list will simply disappear, but in the case of our HTML form, we have already produced a “Results” title for our list, so we have to show something.</div>
          <pre class='Preformatted_20_Text'>54     # Search engine initialisation
55     @engine = SearchEngine.new(&#39;../public/text&#39;, &#39;../public&#39;, &#39;&#39;)
56     @engine.files.each { |file| logger.info(&quot;Loaded #{file.to_s} URL: #{file.url}&quot;) }
57</pre>
          <div class='Text_20_body'>Now we can build the search engine. We set the <span class='Source_20_Text'>remove</span> parameter to <span class='Source_20_Text'>&#39;../public&#39;</span> and the <span class='Source_20_Text'>add</span> parameter to <span class='Source_20_Text'>&#39;&#39;</span>, so that all the text file URLs will map to <span class='Source_20_Text'>&#39;/text/...&#39;</span>. Just to make sure, we log the parsed results, so we can see that the right thing is happening via the server console on line 56.</div>
          <pre class='Preformatted_20_Text'>58     # Define the server mount points
59     mount(&#39;/&#39;, WEBrick::HTTPServlet::FileHandler, &#39;../public&#39;)
60     mount_proc(&#39;/search&#39;) { |req, resp| search(req, resp, true) }
61     mount_proc(&#39;/word&#39;)   { |req, resp| search(req, resp, false) }
62   end
63</pre>
          <div class='Text_20_body'>We use the <span class='Source_20_Text'>mount</span> method to map the <span class='Source_20_Text'>public/</span> folder containing our static files. This tells the server that all server requests beginning with <span class='Source_20_Text'>&#39;/&#39;</span> should be handled as files, and that the <span class='Source_20_Text'>FileHandler</span> should look in the folder <span class='Source_20_Text'>&#39;../public&#39;</span>.</div>
          <div class='Text_20_body'>We use the <span class='Source_20_Text'>mount_proc</span> method to specify the procedure or code block that responds to a specific server URL. Here we map the HTML form URL (<span class='Source_20_Text'>/search</span>) and the Ajax request URL (<span class='Source_20_Text'>/word</span>) to a <span class='Source_20_Text'>search</span> method that we&#39;ll define in a moment. Note that, for HTML form requests, the third parmeter is <span class='Source_20_Text'>true</span>, and for Ajax requests it is <span class='Source_20_Text'>false</span>.</div>
          <pre class='Preformatted_20_Text'>64   # Define the dynamic (HTML form or Ajax) word search response
65   def search(request, response, is_html)
66     word = request.query[&#39;search&#39;] || &#39;&#39;
67     word.strip!
68     results = @engine.search(word)
69     response[&#39;Content-Type&#39;] = &#39;text/html&#39;
70     links = @ajax.result(binding)
71     if is_html
72       response.body = @html.result(binding)
73       logger.info &quot;HTML Word: &#39;#{word}&#39; Results: #{results.inspect}&quot;
74     else
75       response.body = links
76       logger.info &quot;Ajax Word: &#39;#{word}&#39; Results: #{results.inspect}&quot;
77     end
78   end
79 end
80</pre>
          <div class='Text_20_body'>In the <span class='Source_20_Text'>search</span> method the <span class='Source_20_Text'>is_html</span> flag is used to modify the <span class='Source_20_Text'>response</span>, either sending back the XHTML fragment using the <span class='Source_20_Text'>@ajax</span> template, when <span class='Source_20_Text'>is_html</span> is <span class='Source_20_Text'>false</span>, or the entire XHTML document using the <span class='Source_20_Text'>@html</span> template, when <span class='Source_20_Text'>is_html</span> is <span class='Source_20_Text'>true</span>.</div>
          <div class='Text_20_body'>We retrieve the <span class='Source_20_Text'>word</span> from the <span class='Source_20_Text'>request</span> query, using the short circuit technique to guarantee a string value (line 66). The parameter name, <span class='Source_20_Text'>search</span>, matches the <span class='Source_20_Text'>&lt;input&gt;</span> element <span class='Source_20_Text'>name</span> attribute value. We remove any leading and trailing whitespace, and then call the search <span class='Source_20_Text'>@engine</span> for the search <span class='Source_20_Text'>results</span> on line 68.</div>
          <div class='Text_20_body'>Next, we prepare the <span class='Source_20_Text'>response</span>, and use the <a href='http://www.ruby-doc.org/core/classes/Kernel.html'><span class='Source_20_Text'>Kernel</span></a><span class='Source_20_Text'>.binding</span> method to bind our local parameters and variables (<span class='Source_20_Text'>is_html</span>, <span class='Source_20_Text'>word</span>, and <span class='Source_20_Text'>results</span>) to the <span class='Source_20_Text'>@ajax</span> template. Calling the template <span class='Source_20_Text'>result</span> method returns a <span class='Source_20_Text'>String</span>, with all the expressions resolved.</div>
          <div class='Text_20_body'>Next we test if the <span class='Source_20_Text'>is_html</span> flag is true on line 71. If it is, we use the <span class='Source_20_Text'>@html</span> template (which incorporates the <span class='Source_20_Text'>@ajax</span> template result via the <span class='Source_20_Text'>links</span> local variable) to create the <span class='Source_20_Text'>response.body</span>, otherwise the <span class='Source_20_Text'>response.body</span> will consist of the result of the <span class='Source_20_Text'>@ajax</span> template, previously stored in the <span class='Source_20_Text'>links</span> local variable. In both cases, to be sure that the engine is doing the right thing, we send the <span class='Source_20_Text'>results</span> to the server logger (line 73 and 76), using the <span class='Source_20_Text'>Object.inspect</span> method to expand the contents of the array.</div>
          <pre class='Preformatted_20_Text'>81 # Create the server
82 server = SearchServer.new(:Port =&gt; 8086)
83
84 # trap signals to invoke the shutdown procedure cleanly
85 [&#39;INT&#39;, &#39;TERM&#39;].each do |signal|
86   trap(signal) { server.shutdown }
87 end
88
89 # Start the server
90 server.start</pre>
          <div class='Text_20_body'>Finally we create the server, specifying port 8086, instead of the usual port 80, to avoid collisions with other web servers on your computer, such as IIS or Apache. Then we take a code snippet from the <a href='http://microjet.ath.cx/webrickguide/html/'><span class='Internet_20_Hyperlink'>Gnome&#39;s Guide to WEBrick</span></a> to trap shutdown (<span class='Source_20_Text'>Ctrl+C</span>), and start the server.</div>
          <h5 class='Heading_20_5'>The JavaScript File</h5>
          <div class='Text_20_body'>Thanks to the all the code we have written in Ruby, and more importantly, to the script.aculo.us library, the JavaScript code in <span class='Source_20_Text'>search.js</span> is simplicity itself.</div>
          <pre class='Preformatted_20_Text'>01 /*
02  * Word Search
03  */
04
05 document.observe(&#39;dom:loaded&#39;, function() {
06   new Ajax.Autocompleter(&#39;search&#39;, &#39;results&#39;, &#39;/word&#39;, {
07     method: &#39;get&#39;,
08     minChars: 2,
09     updateElement: function(item) { /* no update */ }
10   });
11 });</pre>
          <div class='Text_20_body'>We must specify the input element (<span class='Source_20_Text'>search</span>), output element (<span class='Source_20_Text'>results</span>), and the submission URL (/<span class='Source_20_Text'>word</span>). The important options here are <span class='Source_20_Text'>minChars</span> and <span class='Source_20_Text'>updateElement</span>. We set <span class='Source_20_Text'>minChars</span> to <span class='Source_20_Text'>2</span> because that is also the minimum word length that we parsed in the server.</div>
          <div class='Text_20_body'>Normally <span class='Source_20_Text'>Ajax.Autocompleter</span> will fill the form input element with the value selected from the autocompletion list. In our case this isn&#39;t either necessary nor desired. Our list contains links to the text files, which we expect the user to click. To remove this default behaviour, we provide an empty function for <span class='Source_20_Text'>updateElement</span>.</div>
          <h5 class='Heading_20_5'>The CSS and HTML Files</h5>
          <div class='Text_20_body'>The CSS file, <span class='Source_20_Text'>search.css</span>, is relatively simple, as shown below.</div>
          <pre class='Preformatted_20_Text'>01 body {
02   background-color: #d8ffd8;
03   font: 12pt Verdana, Helvetica, sans-serif;
04 }
05 
06 p, div, ul, li {
07   margin: 0.1em 0.25em;
08   padding: 0;
09 }
10 
11 input {
12   font-family: &#39;Courier New&#39;, Courier, monospace;
13   width: 35ex;
14 }
15</pre>
          <div class='Text_20_body'>The first section sets style rules for the elements in the page. In particular, we set a monospace font for the <span class='Source_20_Text'>&lt;input&gt;</span> element.</div>
          <pre class='Preformatted_20_Text'>16 .title {
17   font-size: 14pt;
18 }
19
20 .search {
21   margin: 1.0em 0.25em;
22 }
23</pre>
          <div class='Text_20_body'>We use two style classes for the page title, and to distance the input field from the title and the results list.</div>
          <pre class='Preformatted_20_Text'>24 .autocomplete {
25   background-color: #d8f8d8;
26   border: 1px solid #4c4c4c;
27   width: 40ex;
28 }
29
30 .autocomplete ul li {
31   font-size: 10pt;
32   list-style-type: none;
33   margin: 0.25em;
34 }
35
36 .autocomplete ul li:hover {
37   background-color: #e8f8e8;
38}</pre>
          <div class='Text_20_body'>The final section of our style sheet defines the appearance and behaviour of the autocompletion list.</div>
          <div class='Text_20_body'>Our application actually &#39;lives&#39; at the URL <span class='Source_20_Text'>/search</span>, but our users will probably be more used to simply typing the root URL <span class='Source_20_Text'>/</span>, which WEBrick converts into a request for <span class='Source_20_Text'>/index.html</span>. This means that we also need to supply a simple static XHTML file which redirects the user to our application:</div>
          <pre class='Preformatted_20_Text'>1 &lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
2 &lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39;&gt;
3   &lt;head&gt;
4     &lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;url=/search&quot; /&gt;
5   &lt;/head&gt;
6   &lt;body&gt;&lt;/body&gt;
7 &lt;/html&gt;</pre>
          <div class='Text_20_body'>The redirect is actioned by the <span class='Source_20_Text'>&lt;meta&gt;</span> element on line 4. This causes the page to be refreshed after <span class='Source_20_Text'>0</span> seconds, using the URL <span class='Source_20_Text'>/search</span>.</div>
          <h4 class='Heading_20_4'>Running the Application.</h4>
          <div class='Text_20_body'>To be able to run the application we need to open a console in the <span class='Source_20_Text'>apps/</span> folder. Start the server by typing <span class='Source_20_Text'>server.rb</span>. At this point we can reference the root URL of our application in a browser by typing <span class='Source_20_Text'>http://localhost:8086/</span>. If all goes well, you should see something like this:</div>
          <div class='Text_20_body_20_centered'><span class='fr1'><img src='LUGPC7Images/firefox1.png' height='337' alt='LUGPC7Images/firefox1.png' width='540' /></span></div>
          <div class='Text_20_body'>Now type in <span class='Source_20_Text'>flowers</span> in the input box, and you should see the following:</div>
          <div class='Text_20_body_20_centered'><span class='fr1'><img src='LUGPC7Images/firefox2.png' height='335' alt='LUGPC7Images/firefox2.png' width='540' /></span></div>
          <div class='Text_20_body'>The console output will also look like the following picture. Note the <span class='Source_20_Text'>&#39;Ajax Word ...&#39;</span> log messages, which refers to data sent in response to the Ajax requests.</div>
          <div class='Text_20_body_20_centered'><span class='fr1'><img src='LUGPC7Images/cmd1.png' height='526' alt='LUGPC7Images/cmd1.png' width='569' /></span></div>
          <div class='Text_20_body'>If you type <span class='Source_20_Text'>flowers</span> reasonably slowly, you will see the list appear once you&#39;ve typed <span class='Source_20_Text'>flow</span>, it then disappears for <span class='Source_20_Text'>flowe</span> and reappears for <span class='Source_20_Text'>flower</span> and <span class='Source_20_Text'>flowers</span>.</div>
          <h5 class='Heading_20_5'>Functional Degradation</h5>
          <div class='Text_20_body'>The specifications also required that our application still work for browsers that have disabled JavaScript, or that have no JavaScript interpreter (such as some mobile telephone browsers).</div>
          <div class='Text_20_body'>Switch off JavaScript in your browser, then refresh the page – you may want to clear the cache first. The result should be:</div>
          <div class='Text_20_body_20_centered'><span class='fr1'><img src='LUGPC7Images/firefox3.png' height='335' alt='LUGPC7Images/firefox3.png' width='540' /></span></div>
          <div class='Text_20_body'>Now type <span class='Source_20_Text'>flowers</span> in the input box, then press <span class='Source_20_Text'>Enter</span>. The result should be:</div>
          <div class='Text_20_body_20_centered'><span class='fr1'><img src='LUGPC7Images/firefox4.png' height='337' alt='LUGPC7Images/firefox4.png' width='540' /></span></div>
          <div class='Text_20_body'>As you can see from the picture above, the value of the input element <span class='Source_20_Text'>search</span> now also appears in the page URL. The console output will look like the following picture. Note that the log now shows only <span class='Source_20_Text'>&#39;HTML Word ...&#39;</span> messages, as no Ajax requests can now be sent. </div>
          <div class='Text_20_body_20_centered'><span class='fr1'><img src='LUGPC7Images/cmd2.png' height='382' alt='LUGPC7Images/cmd2.png' width='569' /></span></div>
          <h4 class='Heading_20_4'>Source Files</h4>
          <div class='Text_20_body'>All the source files for this lesson, including the Aptana project file, can be found in the <a href='http://www.jhl.it/Courses/LUGPC7.zip'><span class='Web_20_Internet_20_Link'>LUGPC7.zip</span></a> archived file, distributed under the <a href='http://www.gnu.org/licenses/lgpl.html'><span class='Internet_20_Hyperlink'>GNU Lesser General Public License</span></a>.</div>
          <h4 class='Heading_20_4'>What&#39;s Next?</h4>
          <div class='Text_20_body'><a href='LUGPC8.html'><span class='Web_20_only_20_Internet_20_Link'>Next</span></a><span class='Web_20_Default'> we&#39;ll </span>take a pause to review some of the important features of Ruby, and take a high level look at Ruby on Rails.</div>
          <div class='content_tags'>Tagged by: <a href='../Tags/Tags_courses.html' class='content_tag'>courses</a>, <a href='../Tags/Tags_programming.html' class='content_tag'>programming</a>, <a href='../Tags/Tags_css.html' class='content_tag'>css</a>, <a href='../Tags/Tags_xhtml.html' class='content_tag'>xhtml</a>, <a href='../Tags/Tags_javascript.html' class='content_tag'>javascript</a>, <a href='../Tags/Tags_ruby.html' class='content_tag'>ruby</a>, <a href='../Tags/Tags_ajax.html' class='content_tag'>ajax</a>, <a href='../Tags/Tags_prototype.html' class='content_tag'>prototype</a>, <a href='../Tags/Tags_scriptaculous.html' class='content_tag'>scriptaculous</a></div>
        </div>
        <div id='rightcol'>
          <div id='contents'>
            <div class='contents-inner'>
              <div class='MenuHeading'>Contents:</div>
              <p class='MenuLevel1'><a href='../Contents.html'>Table of Contents</a></p>
              <p class='MenuLevel2'><a href='../JohnLeach.html'>John Leach</a></p>
              <p class='MenuLevel2 MenuTitle2'>Courses:</p>
              <p class='MenuLevel3'><a href='../Courses/LUGProgrammingCourse.html'>LUG Programming Course 2008</a></p>
              <p class='MenuLevel2 MenuTitle2'>Tutorials:</p>
              <p class='MenuLevel3'><a href='../Tutorials/BeginnersJavaScript.html'>Beginner&#39;s JavaScript</a></p>
              <p class='MenuLevel2'><a href='../RoadMap.html'>Road Map</a></p>
              <p class='MenuLevel1'><a href='../WhatsNew.html'>What&#39;s new</a></p>
            </div>
          </div>
          <div id='tagcloud'>
            <div class='tagcloud-inner'>
              <p class='MenuHeading'>Tag cloud:</p>
              <p class='tags'><span class='tags1'><a href='../Tags/Tags_ajax.html'>ajax(2)</a></span> <span class='tags1'><a href='../Tags/Tags_aptana_studio.html'>aptana studio(1)</a></span> <span class='tags2'><a href='../Tags/Tags_articles.html'>articles(3)</a></span> <span class='tags1'><a href='../Tags/Tags_beginner_s_javascript.html'>beginner&#39;s javascript(1)</a></span> <span class='tags1'><a href='../Tags/Tags_binary_compatibility.html'>binary compatibility(1)</a></span> <span class='tags5'><a href='../Tags/Tags_courses.html'>courses(11)</a></span> <span class='tags2'><a href='../Tags/Tags_css.html'>css(3)</a></span> <span class='tags1'><a href='../Tags/Tags_firebug.html'>firebug(2)</a></span> <span class='tags3'><a href='../Tags/Tags_javascript.html'>javascript(6)</a></span> <span class='tags1'><a href='../Tags/Tags_john_leach.html'>john leach(1)</a></span> <span class='tags6'><a href='../Tags/Tags_programming.html'>programming(14)</a></span> <span class='tags1'><a href='../Tags/Tags_prototype.html'>prototype(2)</a></span> <span class='tags2'><a href='../Tags/Tags_rails.html'>rails(3)</a></span> <span class='tags1'><a href='../Tags/Tags_road_map.html'>road map(1)</a></span> <span class='tags3'><a href='../Tags/Tags_ruby.html'>ruby(6)</a></span> <span class='tags1'><a href='../Tags/Tags_scriptaculous.html'>scriptaculous(2)</a></span> <span class='tags1'><a href='../Tags/Tags_tutorials.html'>tutorials(1)</a></span> <span class='tags1'><a href='../Tags/Tags_unit_testing.html'>unit testing(1)</a></span> <span class='tags1'><a href='../Tags/Tags_what_languages.html'>what languages(1)</a></span> <span class='tags1'><a href='../Tags/Tags_what_s_new.html'>what&#39;s new(1)</a></span> <span class='tags2'><a href='../Tags/Tags_xhtml.html'>xhtml(4)</a></span></p>
            </div>
          </div>
        </div>
      </div>
      <div id='footer'>
        <div class='footer-inner'>
          <p style='text-align: center'><a href='http://www.addthis.com/bookmark.php' onclick='return addthis_click(this);' target='_blank'><img title='AddThis Social Bookmarking' src='../Images/bookmark-button.gif' border='0' height='16' alt='AddThis Social Bookmarking' width='125' /></a>
            <script type='text/javascript' src='../Scripts/AddThis.js'>
              <!-- // bug fix -->
            </script><span style='margin-left: 0.25cm; margin-right: 0.25cm'> </span><a href='http://jigsaw.w3.org/css-validator/check/referer'><img title='Valid CSS' src='../Images/valid-css.png' height='31' alt='Valid CSS' width='88' style='border: 0;' /></a>
             
            <a href='http://validator.w3.org/check/referer'><img title='Valid XHTML 1.0' src='../Images/valid-xhtml10.png' height='31' alt='Valid XHTML 1.0' width='88' style='border: 0;' /></a><!--
            &#160;
            <a href="http://validator.w3.org/feed/check.cgi?url=http%3A//www.jhl.it/jhl.rss"><img src="Images/valid-rss.png" alt="Valid RSS 2.0" title="Valid RSS 2.0 feed" height="31" width="88" style='border: 0;' /></a>
            &#160;
            <a href="jhl.rss"><img src="Images/rss.gif" title="RSS 2.0 Feed" alt="RSS 2.0 Feed" height="28" width="28" style='border: 0;' /></a>
            -->
             
            <a href='http://validator.w3.org/feed/check.cgi?url=http%3A//www.jhl.it/jhl.atom'><img title='Valid Atom 1.0 feed' src='../Images/valid-atom.png' height='31' alt='Valid Atom 1.0' width='88' style='border: 0;' /></a>
             
            <a href='../jhl.atom'><img title='Atom 1.0 Feed' src='../Images/rss.gif' height='28' alt='Atom 1.0 Feed' width='28' style='border: 0;' /></a></p>
          <p>Page source: <a href='http://www.jhl.it/Courses/LUGPC7.html'>http://www.jhl.it/Courses/LUGPC7.html</a></p>
          <p>© Copyright <a href='http://www.jhl.it/'>John Leach</a> 2007-2008. Content licensed according to the <a href='http://opensource.org/licenses/artistic-license-2.0.php'>Artistic License 2.0</a>.</p>
        </div>
      </div>
    </div>
    <script type='text/javascript' src='../Scripts/GoogleAnalytics.js'>
      <!-- // bug fix -->
    </script>
  </body>
</html>

