<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/misc/favicon.ico" type="image/x-icon" />
    <title>Mutex mutandis: understanding mutex types and attributes | embedded-linux.co.uk</title>
    <link type="text/css" rel="stylesheet" media="all" href="/modules/codefilter/codefilter.css?P" />
<link type="text/css" rel="stylesheet" media="all" href="/modules/mollom/mollom.css?P" />
<link type="text/css" rel="stylesheet" media="all" href="/modules/node/node.css?P" />
<link type="text/css" rel="stylesheet" media="all" href="/modules/system/defaults.css?P" />
<link type="text/css" rel="stylesheet" media="all" href="/modules/system/system.css?P" />
<link type="text/css" rel="stylesheet" media="all" href="/modules/system/system-menus.css?P" />
<link type="text/css" rel="stylesheet" media="all" href="/modules/tagadelic/tagadelic.css?P" />
<link type="text/css" rel="stylesheet" media="all" href="/modules/user/user.css?P" />
<link type="text/css" rel="stylesheet" media="all" href="/modules/comment/comment.css?P" />
<link type="text/css" rel="stylesheet" media="all" href="/sites/default/files/color/garland-5055902b/style.css?P" />
<link type="text/css" rel="stylesheet" media="print" href="/themes/garland/print.css?P" />
    <script type="text/javascript" src="/misc/jquery.js?P"></script>
<script type="text/javascript" src="/misc/drupal.js?P"></script>
<script type="text/javascript" src="/modules/mollom/mollom.js?P"></script>
<script type="text/javascript" src="/modules/comment/comment.js?P"></script>
<script type="text/javascript" src="/misc/textarea.js?P"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/" });
//--><!]]>
</script>
    <!--[if lt IE 7]>
      <link type="text/css" rel="stylesheet" media="all" href="/themes/garland/fix-ie.css" />    <![endif]-->
  </head>
  <body class="sidebar-left">

<!-- Layout -->
  <div id="header-region" class="clear-block"></div>

    <div id="wrapper">
    <div id="container" class="clear-block">

      <div id="header">
        <div id="logo-floater">
        <h1><a href="/" title="embedded-linux.co.uk The Inner Penguin"><img src="/sites/default/files/garland_logo.png" alt="embedded-linux.co.uk The Inner Penguin" id="logo" /><span>embedded-linux.co.uk</span> The Inner Penguin</a></h1>        </div>

                  <ul class="links primary-links"><li class="menu-134 first"><a href="/consult/2net" title="Consulting">Consulting</a></li>
<li class="menu-135 last"><a href="/training" title="Training">Training</a></li>
</ul>                                  
      </div> <!-- /header -->

              <div id="sidebar-left" class="sidebar">
                    <div id="block-menu-primary-links" class="clear-block block block-menu">

  <h2>Links</h2>

  <div class="content"><ul class="menu"><li class="leaf first"><a href="/consult/2net" title="Consulting">Consulting</a></li>
<li class="leaf last"><a href="/training" title="Training">Training</a></li>
</ul></div>
</div>
<div id="block-tagadelic-1" class="clear-block block block-tagadelic">

  <h2>Topics</h2>

  <div class="content"><a href="/taxonomy/term/13" class="tagadelic level3" rel="tag">Android</a> 
<a href="/taxonomy/term/6" class="tagadelic level1" rel="tag">Busybox</a> 
<a href="/taxonomy/term/1" class="tagadelic level3" rel="tag">Eclipse</a> 
<a href="/taxonomy/term/11" class="tagadelic level1" rel="tag">Embedded hardware</a> 
<a href="/taxonomy/term/7" class="tagadelic level3" rel="tag">Flash storage</a> 
<a href="/taxonomy/term/14" class="tagadelic level1" rel="tag">gdb</a> 
<a href="/taxonomy/term/12" class="tagadelic level3" rel="tag">i.MX</a> 
<a href="/taxonomy/term/5" class="tagadelic level3" rel="tag">JFFS2</a> 
<a href="/taxonomy/term/10" class="tagadelic level1" rel="tag">Porting</a> 
<a href="/taxonomy/term/9" class="tagadelic level1" rel="tag">Power management</a> 
<a href="/taxonomy/term/3" class="tagadelic level6" rel="tag">Pthreads</a> 
<a href="/taxonomy/term/15" class="tagadelic level1" rel="tag">qemu</a> 
<div class='more-link'><a href="/tagadelic/chunk/1">more tags</a></div></div>
</div>
<div id="block-node-0" class="clear-block block block-node">

  <h2>Syndicate</h2>

  <div class="content"><a href="/rss.xml" class="feed-icon"><img src="/misc/feed.png" alt="Syndicate content" title="Syndicate" width="16" height="16" /></a></div>
</div>
<div id="block-user-0" class="clear-block block block-user">

  <h2>User login</h2>

  <div class="content"><form action="/tutorial/mutex_mutandis?destination=node%2F6"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-1-wrapper">
 <label for="edit-name-1">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name-1" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit-1" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first"><a href="/user/register" title="Create a new user account.">Create new account</a></li>
<li class="last"><a href="/user/password" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-854d2cb3445adfddbc49dac4fea19469" value="form-854d2cb3445adfddbc49dac4fea19469"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
</div>
</div>
        </div>
      
      <div id="center"><div id="squeeze"><div class="right-corner"><div class="left-corner">
          <div class="breadcrumb"><a href="/">Home</a></div>                              <h2>Mutex mutandis: understanding mutex types and attributes</h2>                                                  <div class="clear-block">
            <div id="node-6" class="node">



      <span class="submitted">Mon, 07/06/2009 - 09:42 — csimmonds</span>
  
  <div class="content clear-block">
    <p>The mutex is a simple little thing with one job to do: ensure mutual exclusion between threads. Yet Linux has up to 16 variations of the mutex, depending on which versions of the kernel and C library you have (see the table at the end). In this article I will try to explain why there are so many and how they affect your programs.</p>
<h2>Basics</h2>
<p>A mutex has two states: locked and unlocked. Once it has been locked by one thread any others are forced to wait until the first unlocks it again. Only the thread that locked the mutex may unlock it. With these three facts you can use a mutex to ensure exclusive access to a shared resource, such as a data structure. In the example below I have included the mutex in the structure being protected, which is good design practice</p>
<div class="codeblock"><code>struct some_data {<br />
    pthread_mutex_t data_lock;<br />
    // other data items<br />
} my_data;
<p>...</p>
<p>pthread_mutex_lock (&amp;my_data.data_lock);<br />
// write some values<br />
pthread_mutex_unlock (&amp;my_data.data_lock);<br />
</p></code></div>
<p>Only one thread can hold data_lock at a time, ensuring that the data values are always consistent.</p>
<h2>Complications</h2>
<p>Mutexes are so important to the correct behavior of an application that small details about their implementation can make a big difference overall. Here are some things to consider</p>
<ul>
<li>what is most important: speed or correct behavior?
</li><li>what happens if you try to lock the same mutex twice?
</li><li>if several threads are waiting for a mutex to be unlocked, which one should get the mutex next?
</li><li>is it acceptable for a high priority thread to be blocked indefinitely by a lower priority thread (leading to priority inversion)?
</li><li>what happens if the thread that has locked the mutex terminates without unlocking?
</li></ul>
<p>Your response to these questions will determine the sort of mutex you need.</p>
<h2>Types of mutex: fast, error checking, recursive and adaptive</h2>
<p>Linux has four types of mutex. The code snippets below show how to declare and initialise the default type, which is <b>fast</b>. Sounds good, but what does that mean? It means that speed is preferred over correctness: there is no check that you are the owner in pthread_mutex_unlock() so any thread can unlock a fast mutex. Also it doesn't check if you have already locked the mutex, so you can deadlock yourself, and there are no checks anywhere that the mutex has been intialised correctly.</p>
<p>You declare a mutex of default (fast) type at run-time like this</p>
<div class="codeblock"><code>pthread_mutex_t mutex;<br />
...<br />
pthread_mutex_init (&amp;mutex, NULL);<br />
</code></div>
<p>or statically at compile-time like this</p>
<div class="codeblock"><code>pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;<br />
</code></div>
<p>If you prefer correctness over speed, you need to set the type to be <b>error checking</b>. Error checking mutexes return EDEADLK if you try to lock the same one twice and EPERM if you unlock a mutex that isn't yours. To create such a mutex you need to initialise a <i>muter_attr</i> and pass it to pthread_mutex_init() like so:</p>
<div class="codeblock"><code>pthread_mutex_t mutex;<br />
pthread_mutexattr_t attr;
<p>pthread_mutexattr_init (&amp;attr);<br />
pthread_mutexattr_settype (&amp;attr, PTHREAD_MUTEX_ERRORCHECK_NP);<br />
pthread_mutex_init (&amp;mutex, &amp;attr);<br />
</p></code></div>
<p>or, you can do it statically at compile-time in one line like this:</p>
<div class="codeblock"><code>pthread_mutex_t mutex = PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP;<br />
</code></div>
<p>Note: the _NP suffix indicates a non-portable extension to the POSIX specification. In fact the latest specification, 1003.1-2008 <a href="#ref_2">[2]</a>, includes most of the Linux additions so you can leave the _NP ending off. I have chosen not to because some older versions of the header files only have the _NP variants.</p>
<p>Next is the <b>recursive</b> mutex, which does everything that the error checking mutex does except that you can lock the same mutex multiple times. It keeps a count of the number of times it has been locked and you must unlock it the same number of times before it becomes truly unlocked. As with the other types, you can declare and initialise one like this:</p>
<div class="codeblock"><code><br />
pthread_mutex_t mutex;<br />
pthread_mutexattr_t attr;
<p>pthread_mutexattr_init (&amp;attr);<br />
pthread_mutexattr_settype (&amp;attr, PTHREAD_MUTEX_RECURSIVE_NP);<br />
pthread_mutex_init (&amp;mutex, &amp;attr);<br />
</p></code></div>
<p>or like this:</p>
<div class="codeblock"><code><br />
pthread_mutex_t mutex = PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP;<br />
</code></div>
<p>The last type is <b>adaptive</b> which is an extra fast mutex for multi processor systems. It combines a spinlock with an ordinary mutex: instead of blocking straight away on a locked mutex it spins for a short while re-trying the lock and then blocks in the normal way. On a single processor it doesn't spin and so is identical to a <i>fast</i> mutex.</p>
<h3>Handling errors</h3>
<p>There is not much point using error checking mutexes if you ignore the return value! Except that in reality the main reason that you will get errors from pthread_mutex_lock() and pthread_mutex_unlock() is because of <i>logic</i> errors in your code. I use this macro to detect errors during development and then compile it out for production.</p>
<div class="codeblock"><code>
<pre>#ifdef DEBUG
#define pthread_mutex_lock_check(mutex)		\
({						\
        int __ret = pthread_mutex_lock (mutex);	\
	if (__ret != 0)				\
		printf ("pthread_mutex_lock_check in %s line %u: error %d - %s\n", \
			 __FILE__, __LINE__, __ret, strerror (__ret)); \
	__ret;				\
})
#else
#define pthread_mutex_lock_check pthread_mutex_lock
#endif
</pre><p></p></code></div>
<h3>Wake-up order</h3>
<p>when a mutex is unlocked and there are several threads blocked waiting for it the system has to decide which gets the mutex next. Until recently the choice was simply the thread that had been waiting longest, but with Linux kernels from 2.6.22 onwards the thread chosen will be the highest priority real-time thread. If there are no real-time threads then it will be the longest waiter as before.</p>
<h3>Sharing a mutex between processes</h3>
<p>Most often the shared resource being protected by a mutex is a global variable in a process address space and so the threads using the mutex are all local to that process. Sometimes you will have data in a shared memory segment, for example using the POSIX or SYSV IPC shared memory functions, and so the mutex needs to be locked and unlocked by threads from <i>different</i> processes. In such a case, the mutex must be initialsed with the shared attribute</p>
<div class="codeblock"><code>pthread_mutex_t mutex;<br />
pthread_mutexattr_t attr;
<p>pthread_mutexattr_init (&amp;attr);<br />
pthread_mutexattr_setpshared (&amp;attr, PTHREAD_PROCESS_SHARED);<br />
pthread_mutex_init (&amp;mutex, &amp;attr);<br />
</p></code></div>
<p>Apart from being shared the behavior of the mutex is the same as local ones.</p>
<h2>Problems with real-time threads: priority inversion</h2>
<p>If (and only if) you have threads with real-time scheduling policies SCHED_FIFO or SCHED_RR you may experience <i>priority inversion</i><a href="#ref_3">[3]</a> which results in a high priority thread that is waiting to lock a mutex being blocked by a lower priority thread. One way to resolve the problem is to set the priority protocol of the mutex to <i>priority inheritance</i>, with the result that the thread holding the mutex inherits the priority of the highest priority thread waiting for the mutex and so it cannot be preempted by intermediate priority threads. Here is how to do it</p>
<div class="codeblock"><code><br />
#define __USE_UNIX98	/* Needed for PTHREAD_PRIO_INHERIT */<br />
#include &lt;pthread.h&gt;
<p>pthread_mutex_t mutex;<br />
pthread_mutexattr_t attr;</p>
<p>pthread_mutexattr_init (&amp;attr);<br />
pthread_mutexattr_setprotocol (&amp;attr, PTHREAD_PRIO_INHERIT);<br />
pthread_mutex_init (&amp;mutex, &amp;attr);<br />
</p></code></div>
<p>Priority inheritance can be combined with any of the four types. However, it adds a large overhead to the implementation and so it does not make sense to combine it with the <i>fast</i> or <i>adaptive</i> types.</p>
<h2>Unexpected termination: the robust mutex</h2>
<p>Supposing a thread has locked a mutex and then terminates, what then? In the normal run of things the mutex  will remain locked for ever (OK, until the next reboot), causing any threads trying to lock it to  deadlock. This is particularly a problem if you are sharing a mutex between processes and one of them segfaults or is killed. </p>
<p>This is where the <b>robust</b> attribute comes in. The first stage is to initialise the mutex with the robust option. It can be combined with any of the four types and with the priority inheritance attribute. Here we go:</p>
<div class="codeblock"><code><br />
#define __USE_GNU	/* Needed for PTHREAD_MUTEX_ROBUST_NP */<br />
#include &lt;pthread.h&gt;
<p>pthread_mutex_t mutex;<br />
pthread_mutexattr_t attr;</p>
<p>pthread_mutexattr_init (&amp;attr);<br />
pthread_mutexattr_setrobust_np (&amp;attr, PTHREAD_MUTEX_ROBUST_NP);<br />
pthread_mutex_init (&amp;mutex, &amp;attr);<br />
</p></code></div>
<p>Now, if the thread owning the mutex terminates with it locked, any other thread that is trying to lock it will unblock with error code EOWNERDEAD. In other words, this mutex no longer functions as a mutex. If you want to repair the situation you must validate the data that the mutex was protecting, maybe remove some inconsistent state, and then call pthread_mutex_consistent_np(). Then you must lock it, in the same thread that marked it as consistent. Now it is a fully functional mutex again.</p>
<p>Finally, if the mutex is unlocked without being made consistent, it will be in a permanently unusable state and all attempts to lockit will fail with the error ENOTRECOVERABLE. You have blown it: the only thing you can do with such a mutex is to destroy it.</p>
<p>All the above adds quite a lot of complexity to the implementation of a mutex, so robust mutexes are NOT going to be fast.</p>
<h2>Summary</h2>
<p>We have four types of mutex each of which may be robust and may have the priority inheritance protocol, which gives us 4 x 2 x 2 = 16 different possibilities. Here are my suggestions on which to use.</p>
<ul>
<li>During development, use error checking - the extra overhead is very small
</li><li>Use recursive mutexes if you have library code where you cannot be sure that a mutex has already been locked elsewhere
</li><li>In high performance production code, use fast or (if you have more than one CPU) adaptive types
</li><li>If you have real time threads, look carefully at the dependencies between the threads and use priority inheritance where necessary
</li><li>If you share mutexes between processes (or if your threads terminate in odd places) use robust mutexes
</li></ul>
<h3>Features vs libc version</h3>
<p>Some features are dependent on the version of the 'C' library you use. Here I am considering the two most often used in embedded devices: GNU libc (glibc) and the microcontroller C library, uClibc <a href="#ref_4">[4]</a>.</p>
<ul>
<li>Fast, error checking and recursive mutex types are present in all versions of glibc and uClibc
</li><li>The adaptive type and the robust and priority inheritance protocol are ONLY implemented in glibc 2.5 onwards
</li><li>Main-line uClibc DOES NOT implement adaptive, robust and priority inheritance (*)
</li></ul>
<p>(*) Because uClibc uses the older LinuxThreads library, not the Native POSIX Threads (nptl) library as glibc does. There is an on-going project to port nptl to uClibc but it is not yet functional on all architectures.</p>
<h3>Features vs kernel version</h3>
<p>If you are using glibc (or uClibc with nptl) you also need to keep a watch on the kernel version. Here are the minimum versions for the various features</p>
<table width=600>
<tr bgcolor="grey" align="left">
<td width=25%>Normal</td>
<td width=25%>Robust</td>
<td width=25%>Priority Inheritance</td>
<td width=25%>Priority wake-up queue</td>
</tr>
<tr bgcolor="lightgrey">
<td>2.6.0</td>
<td>2.6.17</td>
<td>2.6.18</td>
<td>2.6.22</td>
</tr>

</table>
<h2>References</h2>
<p><a name="ref_1">[1] The title <i>mutex mutandis</i> is a really bad pun on the phrase <i>mutatis mutandis</i>, meaning "the necessary changes having been made", see <a href="http://en.wikipedia.org/wiki/Mutatis_mutandis" title="http://en.wikipedia.org/wiki/Mutatis_mutandis">http://en.wikipedia.org/wiki/Mutatis_mutandis</a><br />
<a name="ref_2">[2] IEEE Std 1003.1-2008 System Interfaces <a href="http://www.opengroup.org/onlinepubs/9699919799/functions/contents.html" title="http://www.opengroup.org/onlinepubs/9699919799/functions/contents.html">http://www.opengroup.org/onlinepubs/9699919799/functions/contents.html</a><br />
<a name="ref_3">[3] For a description of priority inversion see <a href="http://en.wikipedia.org/wiki/Priority_inversion" title="http://en.wikipedia.org/wiki/Priority_inversion">http://en.wikipedia.org/wiki/Priority_inversion</a><br />
<a name="ref_4">[4] uClibc can be found at <a href="http://www.uclibc.org/" title="http://www.uclibc.org/">http://www.uclibc.org/</a></a></a></a></a></p>
<p>Chris Simmonds<br />
<a href="mailto:chris@2net.co.uk">chris@2net.co.uk</a></p>
  </div>

  <div class="clear-block">
    <div class="meta">
          <div class="terms"><ul class="links inline"><li class="taxonomy_term_3 first last"><a href="/taxonomy/term/3" rel="tag" title="About POSIX threads">Pthreads</a></li>
</ul></div>
        </div>

      </div>

</div>
<div id="comments">
  <h2 class="comments">Comments</h2><form action="/tutorial/mutex_mutandis"  accept-charset="UTF-8" method="post" id="comment-controls">
<div><div class="box">

  <h2>Comment viewing options</h2>

  <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-12186331f7b24d99205f59e7100614b7" value="form-12186331f7b24d99205f59e7100614b7"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4" selected="selected">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1" selected="selected">Date - newest first</option><option value="2">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50" selected="selected">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
</div>

</div></form>
<a id="comment-3428"></a>
<div class="comment comment-published odd">

  <div class="clear-block">
      <span class="submitted">Thu, 08/26/2010 - 22:38 — IanVaughan</span>
  
  
  
    <h3><a href="/tutorial/mutex_mutandis#comment-3428" class="active">Shared mutex : has to passed to users?</a></h3>

    <div class="content">
      <p>When creating a shared mutex via PTHREAD_PROCESS_SHARED<br />
Does the "pthread_mutex_t mutex" instance/ID/handle returned from pthread_mutex_init have to sent to all the sharing processes?<br />
i.e. I have two separate programs, when started they commutate via TCP messages, but they are in there own process space.<br />
If I want both to lock/unlock on the same mutex, do I have to create the mutex as above in one program, and send the handle/ID to the other?</p>
          </div>
  </div>

      <div class="links"><ul class="links"><li class="comment_reply first last"><a href="/comment/reply/6/3428">reply</a></li>
</ul></div>
  </div>
<div class="indented"><a id="comment-5474"></a>
<div class="comment comment-published even">

  <div class="clear-block">
      <span class="submitted">Sat, 09/04/2010 - 21:42 — csimmonds</span>
  
  
  
    <h3><a href="/tutorial/mutex_mutandis#comment-5474" class="active">Re: Shared mutex : has to be passed to users?</a></h3>

    <div class="content">
      <p>Yes, all processes wishing to lock the mutex must have a reference to the pthread_mutex_t that defines it. In practice, the shared mutex is always defined in a shared memory segment along with the data structures it is protecting, so the mechanism for sharing the mutex descriptor is there all along.</p>
          </div>
  </div>

      <div class="links"><ul class="links"><li class="comment_reply first last"><a href="/comment/reply/6/5474">reply</a></li>
</ul></div>
  </div>
</div><a id="comment-3343"></a>
<div class="comment comment-published odd">

  <div class="clear-block">
      <span class="submitted">Mon, 06/28/2010 - 23:51 — maimutoi</span>
  
  
  
    <h3><a href="/tutorial/mutex_mutandis#comment-3343" class="active">very useful</a></h3>

    <div class="content">
      <p>It has saved a lot of my time. Thanks</p>
          </div>
  </div>

      <div class="links"><ul class="links"><li class="comment_reply first last"><a href="/comment/reply/6/3343">reply</a></li>
</ul></div>
  </div>
<a id="comment-3248"></a>
<div class="comment comment-published even">

  <div class="clear-block">
      <span class="submitted">Wed, 09/09/2009 - 10:16 — feabhas</span>
  
  
  
    <h3><a href="/tutorial/mutex_mutandis#comment-3248" class="active">Great article</a></h3>

    <div class="content">
      <p>Great explanation of the Linux mutex, just what was needed. I've heard the term "futex" used to refer to the "fast mutex". Is this  common term in the Embedded Linux community?<br />
Can a fast mutex have priority inheritance? This seems counter intuitive if no check is made who is the mutex owner?</p>
          </div>
  </div>

      <div class="links"><ul class="links"><li class="comment_reply first last"><a href="/comment/reply/6/3248">reply</a></li>
</ul></div>
  </div>
<div class="indented"><a id="comment-3251"></a>
<div class="comment comment-published odd">

  <div class="clear-block">
      <span class="submitted">Wed, 09/09/2009 - 21:06 — csimmonds</span>
  
  
  
    <h3><a href="/tutorial/mutex_mutandis#comment-3251" class="active">Futex</a></h3>

    <div class="content">
      <p>The futex (fast user-space mutex) is the low level primitive used to implement the types of mutex I describe in the article, but unless you are writing a replacement POSIX thread library you will never see a futex in the flesh. So, to answer the question directly: yes futexes can have priority inheritance and ownership, depending on the attributes of the upper level mutex.</p>
          </div>
  </div>

      <div class="links"><ul class="links"><li class="comment_reply first last"><a href="/comment/reply/6/3251">reply</a></li>
</ul></div>
  </div>
</div><a id="comment-3247"></a>
<div class="comment comment-published even">

  <div class="clear-block">
      <span class="submitted">Wed, 09/02/2009 - 16:19 — wibble</span>
  
  
  
    <h3><a href="/tutorial/mutex_mutandis#comment-3247" class="active">Priority ceiling</a></h3>

    <div class="content">
      <p>You mention the priority inheritance protocol. Does Linux have the priority ceiling protocol as well?</p>
          </div>
  </div>

      <div class="links"><ul class="links"><li class="comment_reply first last"><a href="/comment/reply/6/3247">reply</a></li>
</ul></div>
  </div>
<div class="indented"><a id="comment-3252"></a>
<div class="comment comment-published odd">

  <div class="clear-block">
      <span class="submitted">Wed, 09/09/2009 - 21:54 — csimmonds</span>
  
  
  
    <h3><a href="/tutorial/mutex_mutandis#comment-3252" class="active">Priority ceiling</a></h3>

    <div class="content">
      <p>Yes, that is a little detail I missed out of the article. The function pthread_mutexattr_setprotocol can take three values<br />
    PTHREAD_PRIO_NONE  - no priority protocol (the default)<br />
    PTHREAD_PRIO_INHERIT  - priority inheritance, as described above<br />
    PTHREAD_PRIO_PROTECT - priority ceiling</p>
<p>After selecting PTHREAD_PRIO_PROTECT you need to give the mutex a priority in the range 1 to 99 with</p>
<p>    pthread_mutexattr_setprioceiling(pthread_mutexattr_t *attr,  int prioceiling); </p>
<p>Now, when a thread blocks on the mutex, its priority will be the higher of the thread's priority and the ceiling priority of the mutex. To be useful, the ceiling priority must be higher than or equal to the highest priority of any thread that may try to lock it, thus avoiding priority inversion. As you can see, the priority ceiling protocol puts a bit more responsibility on the programmer than priority inheritance.</p>
<p>Note: including this option, we have 24 types of mutex!</p>
          </div>
  </div>

      <div class="links"><ul class="links"><li class="comment_reply first last"><a href="/comment/reply/6/3252">reply</a></li>
</ul></div>
  </div>
</div><div class="box">

  <h2>Post new comment</h2>

  <div class="content"><form action="/comment/reply/6"  accept-charset="UTF-8" method="post" id="comment-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Your name: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="30" value="Visitor" class="form-text required" />
</div>
<div class="form-item" id="edit-mail-wrapper">
 <label for="edit-mail">E-mail: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="64" name="mail" id="edit-mail" size="30" value="" class="form-text required" />
 <div class="description">The content of this field is kept private and will not be shown publicly.</div>
</div>
<div class="form-item" id="edit-homepage-wrapper">
 <label for="edit-homepage">Homepage: </label>
 <input type="text" maxlength="255" name="homepage" id="edit-homepage" size="30" value="" class="form-text" />
</div>
<div class="form-item" id="edit-subject-wrapper">
 <label for="edit-subject">Subject: </label>
 <input type="text" maxlength="64" name="subject" id="edit-subject" size="60" value="" class="form-text" />
</div>
<div class="form-item" id="edit-comment-wrapper">
 <label for="edit-comment">Comment: <span class="form-required" title="This field is required.">*</span></label>
 <textarea cols="60" rows="15" name="comment" id="edit-comment"  class="form-textarea resizable required"></textarea>
</div>
<ul class="tips"><li>Web page addresses and e-mail addresses turn into links automatically.</li><li>Allowed HTML tags: &lt;a&gt; &lt;em&gt; &lt;strong&gt; &lt;cite&gt; &lt;code&gt; &lt;ul&gt; &lt;ol&gt; &lt;li&gt; &lt;dl&gt; &lt;dt&gt; &lt;dd&gt;</li><li>Lines and paragraphs break automatically.</li></ul><p><a href="/filter/tips">More information about formatting options</a></p><input type="hidden" name="form_build_id" id="form-8bf49c4de8e55302b0f6b99f2b5a9184" value="form-8bf49c4de8e55302b0f6b99f2b5a9184"  />
<input type="hidden" name="form_id" id="edit-comment-form" value="comment_form"  />
<input type="hidden" name="mollom[session_id]" id="edit-mollom-session-id" value=""  class="mollom-session-id" />
<div class="description mollom-privacy">By submitting this form, you accept the <a href="http://mollom.com/web-service-privacy-policy">Mollom privacy policy</a>.</div><input type="submit" name="op" id="edit-preview" value="Preview"  class="form-submit" />

</div></form>
</div>
</div>
</div>
          </div>
                    <div id="footer"></div>
      </div></div></div></div> <!-- /.left-corner, /.right-corner, /#squeeze, /#center -->

      
    </div> <!-- /container -->
  </div>
<!-- /layout -->

    </body>
</html>
