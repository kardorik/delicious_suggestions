<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Space Vatican : Creating multiple associations with the same table </title>
  <meta name="generator" content="Mephisto" />
  <link href="/stylesheets/main.css" rel="stylesheet" type="text/css" />
  <link href="/feed/atom.xml" rel="alternate" title="Articles for Home" type="application/atom+xml" />
<link rel="stylesheet" href="/stylesheets/uv/twilight.css" type="text/css" media="screen" />
</head>
<body>

  <div id="wrap">
    <div id="header"><h1><a href="/">Space Vatican</a></h1>
      <p class="description">Ramblings and craziness</p>
    </div>
    <div id="content">
      
  
<div class="entry entry-9">
	<div class="entrytitle">
		<h2><a href="/2008/5/6/creating-multiple-associations-with-the-same-table" title="Creating multiple associations with the same table">Creating multiple associations with the same table</a></h2> 
		<h3>May 6th, 2008</h3>
	</div>
	<div class="entrybody">
	  
		  
		
		
		  <p>Rails makes setting up your associations dead easy and very concise. There's a whole bunch of options that can be set however as long as you are following Rails' conventions you very rarely need to use them. If you're new to rails you might not even know they exists and get away with it 99% of the time. One case where you do is when you've got more than one association pointing at the same table. </p>

<p>If you wrote an application tracking sales between individuals (lets call it railsbay) you might have a table called sales and in that table you'd need to track the buyer and the seller. Both buyer and seller should be objects from the users table, and we've got two columns that refer to them: buyer_id and seller_id. Before we tackle what we actually want to do, lets take a step back. This would all be really easy if there was only one user associated with a sale. So lets take a look at what happens inside when we write</p>

<pre class="twilight">
<span class="Keyword">class</span> <span class="Entity">Sale<span class="EntityInheritedClass"> <span class="EntityInheritedClass">&lt;</span> ActiveRecord::Base</span></span>
  <span class="SupportFunction">belongs_to</span> <span class="Constant"><span class="Constant">:</span>user</span>
<span class="Keyword">end</span>
</pre>

<p>When you do this <a href="#note_1" name="1_source">[1]</a>, ActiveRecord derives the class name by taking :user and camelizing it to get User, the assumed class name (if this was a has_many, it would also singularize, so Users -> User). If you specify a class_name option, that takes priority. The foreign key (the database column containing the id of the associated user, in this case user_id) is derived by taking the name (user) and adding _id <a href="#note_2" name="2_source">[1]</a>. It could be overridden with :foreign_key. The first parameter (:user) is the name of association, so in particular it is the name of the method you call to get the value of the association. All this means is that we could also have written</p>

<pre class="twilight">
<span class="Keyword">class</span> <span class="Entity">Sale<span class="EntityInheritedClass"> <span class="EntityInheritedClass">&lt;</span> ActiveRecord::Base</span></span>
  <span class="SupportFunction">belongs_to</span> <span class="Constant"><span class="Constant">:</span>user</span>, <span class="Constant"><span class="Constant">:</span>class_name</span> =&gt; <span class="String"><span class="String">'</span>User<span class="String">'</span></span>, <span class="Constant"><span class="Constant">:</span>foreign_key</span> =&gt; <span class="String"><span class="String">'</span>user_id<span class="String">'</span></span>
<span class="Keyword">end</span>
</pre>

<p>It's rather verbose, so we don't. If you didn't like your users (that's not really a good idea) you can say</p>

<pre class="twilight">
<span class="Keyword">class</span> <span class="Entity">Sale<span class="EntityInheritedClass"> <span class="EntityInheritedClass">&lt;</span> ActiveRecord::Base</span></span>
  <span class="SupportFunction">belongs_to</span> <span class="Constant"><span class="Constant">:</span>nasty_user</span>, <span class="Constant"><span class="Constant">:</span>class_name</span> =&gt; <span class="String"><span class="String">'</span>User<span class="String">'</span></span>, <span class="Constant"><span class="Constant">:</span>foreign_key</span> =&gt; <span class="String"><span class="String">'</span>user_id<span class="String">'</span></span>
<span class="Keyword">end</span>
</pre>

<p>and now you need to access the association as sale.nasty_user instead of sale.user.</p>

<p>We can now return to the original problem. We've got 2 users to associate, a buyer and a seller, so the associations might as well use those names. Our foreign keys are buyer_id and seller_id, and in both cases the association will refer to a User, so we need :class_name => 'User'</p>

<pre class="twilight">
<span class="Keyword">class</span> <span class="Entity">Sale<span class="EntityInheritedClass"> <span class="EntityInheritedClass">&lt;</span> ActiveRecord::Base</span></span>
  <span class="SupportFunction">belongs_to</span> <span class="Constant"><span class="Constant">:</span>buyer</span>, <span class="Constant"><span class="Constant">:</span>class_name</span> =&gt; <span class="String"><span class="String">'</span>User<span class="String">'</span></span>, <span class="Constant"><span class="Constant">:</span>foreign_key</span> =&gt; <span class="String"><span class="String">'</span>buyer_id<span class="String">'</span></span>
  <span class="SupportFunction">belongs_to</span> <span class="Constant"><span class="Constant">:</span>seller</span>, <span class="Constant"><span class="Constant">:</span>class_name</span> =&gt; <span class="String"><span class="String">'</span>User<span class="String">'</span></span>, <span class="Constant"><span class="Constant">:</span>foreign_key</span> =&gt; <span class="String"><span class="String">'</span>seller_id<span class="String">'</span></span>
<span class="Keyword">end</span>
</pre>

<p>You don't actually need the foreign key in this case (since the default is association name + _id (from rails 2.0) so this simplifies down to</p>

<pre class="twilight">
<span class="Keyword">class</span> <span class="Entity">Sale<span class="EntityInheritedClass"> <span class="EntityInheritedClass">&lt;</span> ActiveRecord::Base</span></span>
  <span class="SupportFunction">belongs_to</span> <span class="Constant"><span class="Constant">:</span>buyer</span>, <span class="Constant"><span class="Constant">:</span>class_name</span> =&gt; <span class="String"><span class="String">'</span>User<span class="String">'</span></span>
  <span class="SupportFunction">belongs_to</span> <span class="Constant"><span class="Constant">:</span>seller</span>, <span class="Constant"><span class="Constant">:</span>class_name</span> =&gt; <span class="String"><span class="String">'</span>User<span class="String">'</span></span>
<span class="Keyword">end</span>
</pre>

<p>Easy! Now we just need to do the other side of the association. A user will have many sales as a seller and many sales as a buyer, we'll call the associations sales and purchases. Like before, the association name determines the method you call to get/set an association. ActiveRecord assumes the defaults in much the same way, so from</p>

<pre class="twilight">
<span class="Keyword">class</span> <span class="Entity">User<span class="EntityInheritedClass"> <span class="EntityInheritedClass">&lt;</span> ActiveRecord::Base</span></span>
  <span class="SupportFunction">has_many</span> <span class="Constant"><span class="Constant">:</span>sales</span>
<span class="Keyword">end</span>
</pre>

<p>ActiveRecord infers that the class is Sale (overridable by the :class_name option). The foreign key inference is different. Since we're talking creating assocations on the User class, ActiveRecord assumes that database columns pointing at this table are called user_id (underscorize the class name and add id <a href="#note_3" name="1_source">[3]</a>). So the above is equivalent to </p>

<pre class="twilight">
<span class="Keyword">class</span> <span class="Entity">User<span class="EntityInheritedClass"> <span class="EntityInheritedClass">&lt;</span> ActiveRecord::Base</span></span>
  <span class="SupportFunction">has_many</span> <span class="Constant"><span class="Constant">:</span>sales</span>, <span class="Constant"><span class="Constant">:</span>class_name</span> =&gt; <span class="String"><span class="String">'</span>Sale<span class="String">'</span></span>, <span class="Constant"><span class="Constant">:</span>foreign_key</span> =&gt; <span class="String"><span class="String">'</span>user_id<span class="String">'</span></span>
<span class="Keyword">end</span>
</pre>

<p>Our associations are called sales and purchases, both refer to things of class Sale and the foreign keys are buyer_id and seller_id, so our User class should look like</p>

<pre class="twilight">
<span class="Keyword">class</span> <span class="Entity">User<span class="EntityInheritedClass"> <span class="EntityInheritedClass">&lt;</span> ActiveRecord::Base</span></span>
  <span class="SupportFunction">has_many</span> <span class="Constant"><span class="Constant">:</span>purchases</span>, <span class="Constant"><span class="Constant">:</span>class_name</span> =&gt; <span class="String"><span class="String">'</span>Sale<span class="String">'</span></span>, <span class="Constant"><span class="Constant">:</span>foreign_key</span> =&gt; <span class="String"><span class="String">'</span>buyer_id<span class="String">'</span></span>
  <span class="SupportFunction">has_many</span> <span class="Constant"><span class="Constant">:</span>sales</span>, <span class="Constant"><span class="Constant">:</span>class_name</span> =&gt; <span class="String"><span class="String">'</span>Sale<span class="String">'</span></span>, <span class="Constant"><span class="Constant">:</span>foreign_key</span> =&gt; <span class="String"><span class="String">'</span>seller_id<span class="String">'</span></span>
<span class="Keyword">end</span>
</pre>

<p>If you want you can drop the :class_name option from the sales association, it's not needed. There we go, you are now an association master! The same ideas apply in the other cases where the defaults aren't write. Always make the association name unique (try and come up with a good name, it will really help the readability of your code), and then set foreign_key and class_name options appropriately. I haven't talked about has_many :through at all, but that's because Josh Susser already has a lovely writeup of  that <a href="http://blog.hasmanythrough.com/2007/10/30/self-referential-has-many-through">over here</a>.</p>

<p><a name="note_1" href="#1_source">[1]</a>This is a slight lie. ActiveRecord does very little when you call belongs_to, has_many etc... all these things are computed when they are needed. That distinction isn't really important here.</p>

<p><a name="note_2" href="#2_source">[2]</a>ActiveRecord use to base this on the :class_name option, ie the default key was (basically) the lowercased class name followed by _id. This changed in rails 2.0</p>

<p><a name="note_3" href="#3_source">[3]</a>There's a bit more to this in cases where your models are in modules and so on. The gory details are in Inflector#foreign_key</p>
		
	</div>
	
	<div class="entrymeta">
	<div class="postinfo">
		<span class="postedby">Posted by fred</span>
		<span class="filedto">Filed in <a href="/rails" title="Rails">Rails</a></span>
	</div>
	
	</div>
	
</div>


  <div class="commentsblock">
    
	<h3 id="comments">1 Response to &#8220;Creating multiple associations with the same table&#8221;</h3> 
	<ol class="commentlist">
	
		<li class="alt" id="comment-13">
			<cite><a href="http://espndev.com/blog">Dary</a></cite> Says:
			<br />
			<small class="commentmetadata"><a href="#comment-13" title="">May 15th, 2008 at 06:27 AM</a></small>
			You, sir, have made my night. I have Game and Team models and for the life of me could not figure out how to construct the association with both away and home teams. This is it! Thanks so so so so much :)

PS I love that I found your post by thinking "When else would this definitely have cropped up? Hmm..." and then googled "rails seller_id buyer_id" :)
		</li>
  
	</ol>




<p>Sorry, comments are closed for this article.</p>


  </div>



    </div>
    <div id="sidebar">
      <h2>Search</h2>
      <form method="get" id="sform" action="/search">
        <label for="q">Search:</label>
				<input type="text" id="q" value="" name="q" size="15" />
			</form>
      
        <h2>Pages</h2>
        <ul>
          <li><a href="/about-me" title="About me">About me</a></li>
        </ul>
      
      <h2>Categories</h2>
      <ul>
        <li><a href="/" title="Home">Home</a></li><li><a href="/rails" title="Rails">Rails</a></li><li><a href="/rails-falling-off-the-edge" title="Rails: Falling off the Edge">Rails: Falling off the Edge</a></li><li><a href="/ruby" title="Ruby">Ruby</a></li>
      </ul>
    </div>
  </div>
  <div id="footer">Space Vatican is proudly using the <a href="http://ifelse.co.uk/simpla">Simpla theme</a> originally designed by <a href="http://ifelse.co.uk">Phu</a>. Powered by <a href="http://mephistoblog.com/">Mephisto</a>. Copyright &copy; Frederick Cheung</div>
</body>
</html>
