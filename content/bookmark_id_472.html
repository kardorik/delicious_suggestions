<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">

<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>32bitkid.com  &raquo; Blog Archive   &raquo; Multiple Foreign Keys In Rails&#8230;</title>

<meta name="generator" content="WordPress 3.0.1" /> <!-- leave this for stats -->

<link rel="stylesheet" href="http://www.32bitkid.com/wp-content/themes/32bitkid-template/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="32bitkid.com RSS Feed" href="http://www.32bitkid.com/feed/" />
<link rel="pingback" href="http://www.32bitkid.com/xmlrpc.php" />

<link rel="alternate" type="application/rss+xml" title="32bitkid.com &raquo; Multiple Foreign Keys In Rails&#8230; Comments Feed" href="http://www.32bitkid.com/2008/11/12/multiple-foreign-keys-in-rails/feed/" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.32bitkid.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.32bitkid.com/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='32bitkid.com' href='http://www.32bitkid.com/' />
<link rel='start' title='After a very long hiatus&#8230;' href='http://www.32bitkid.com/2007/12/25/long-hiatus/' />
<link rel='prev' title='I&#8217;m really excited about the OutPacker' href='http://www.32bitkid.com/2008/11/10/im-really-excited-about-the-outpacker/' />
<link rel='next' title='Hoarding the Dead' href='http://www.32bitkid.com/2008/11/13/hoarding-the-dead/' />
<meta name="generator" content="WordPress 3.0.1" />
<link rel='canonical' href='http://www.32bitkid.com/2008/11/12/multiple-foreign-keys-in-rails/' />
<link rel='shortlink' href='http://www.32bitkid.com/?p=23' />

</head>
<body>
	<div id="main-top">
		<div id="main-top-left"></div>
		<div id="main-top-right"></div>		
	</div>
	
	<div id="main">
		<div id="header">
			<a href="http://www.32bitkid.com/"><img src="http://www.32bitkid.com/wp-content/themes/32bitkid-template/images/thirtytwobitkid-green.gif" alt="32bitkid.com" /></a>
			<div id="header-navigation">
				<ul>
					<li><a href="http://www.32bitkid.com/">Home</a></li>
					<li class="page_item page-item-4"><a href="http://www.32bitkid.com/portfolio/" title="Portfolio">Portfolio</a></li>
<li class="page_item page-item-3"><a href="http://www.32bitkid.com/resume/" title="Resume">Resume</a></li>
				</ul>
			</div>			
		</div>			
	<div id="content-wide">

	
		<div class="navigation">
			<div class="alignleft">&laquo; <a href="http://www.32bitkid.com/2008/11/10/im-really-excited-about-the-outpacker/" rel="prev">I&#8217;m really excited about the OutPacker</a></div>
			<div class="alignright"><a href="http://www.32bitkid.com/2008/11/13/hoarding-the-dead/" rel="next">Hoarding the Dead</a> &raquo;</div>
		</div>
		
        <div style="clear: both;"> </div>
		
		<div class="post" id="post-23">
			<h2><a href="http://www.32bitkid.com/2008/11/12/multiple-foreign-keys-in-rails/" rel="bookmark" title="Permanent Link: Multiple Foreign Keys In Rails&#8230;">Multiple Foreign Keys In Rails&#8230;</a></h2>

			<div class="entry">
				<p>So yesterday at work, I ran into a seriously interesting problem and its the first time in the three years I’ve been working with Rails that I’ve really butted heads with ActiveRecord. I’m not really sure if ActiveRecord won or I did, but I eventually got it to work. Luckily, I can blame most of the problem on will_paginate and my own laziness.</p>
<p>Here is the scenario: I’ve got a model, lets call it Items. Now Item belongs to Users by the way of user_id. However it is also possible for different User to temporarily rent an Item, this is represented using renter_id.</p>
<p>Now in Rails this is pretty straight forward:<br />
<code>class Item < ActiveRecord::Base<br />
  belongs_to :user<br />
  belongs_to :renter, :class_name => “User”<br />
end<br />
class User < ActiveRecord::Base<br />
  has_many :my_items, :class_name => “Item”, :foreign_key => “user_id”<br />
  has_many :rented_items, :class_name => “Item”, :foreign_key => “renter_id”<br />
end</code></p>
<p>No problem, right? Well, what if i wanted a list of all items that a User has access to. I basically want a mySQL select of this:<br />
<code>SELECT * FROM items WHERE (items.user_id = user.id or items.renter_id = user.id)</code></p>
<p>What would I like to do is this:<br />
<code>has_many :items, :foreign_key => ["user_id", "renter_id"]</code></p>
<p>Unfortunately that was not to be. So my next idea was just to use a method that gathers both and passes it back. For example:<br />
<code>def items<br />
  my_items + rented_items<br />
end</code></p>
<p>However, this is gloriously inefficient, requiring the entire collection to be gathered from the database then chopped up and paginated in Ruby. Bad idea… Besides, will_paginate doesn’t like working that way (which is a good thing)</p>
<p>After beating my head against rails and mySQL and trying to remember which comes first AND or OR. I finally broke down and decided to implement it old school using :finder_sql, which ended up looking something like this:<br />
<code>has_many :items, :finder_sql => 'SELECT * FROM items WHERE (items.user_id = #{id} or items.renter_id = #{id})'</code></p>
<p>(And yes the single quotes are quite important in this context because you want the literal string ‘#{id}’ to be evaluated later, not when the string is generated.)</p>
<p>And this will work fine for things like User.find(:first).items, and I was happy. Until I tried to do User.find(:first).items.paginate and it freaked the hell out (being unable to build a proper request from the finder_sql which is totally understandable). And again I fell into despair and hit up the rails api. And lo and behold I found the :extend key on has_many. What it allows you to do is define custom methods, usually finders or creators for the assocation, using the proxy reflection data that it provides it was “easy-ish” to accomplish what I wanted to do, by overwriting the paginate method from will_paginate and build the Pagination collection by hand, and the controller programmer is none the wiser that I have totally hijacked the ball.</p>
<p>It ended up looking something like this:<br />
<code>has_many :items, :finder_sql => 'SELECT * FROM items WHERE (items.user_id = #{id} or items.renter_id = #{id})' do<br />
  def paginate(page, per_page)<br />
    total_entries = proxy_reflection.class_name.constantize.count_by_sql proxy_reflection.options[:counter_sql].gsub(’#{id}’, proxy_owner.id.to_s)<br />
    WillPaginate::Collection.create(page || 1, per_page || 10, total_entries) do |pager|<br />
      pager.replace proxy_reflection.class_name.constantize.find_by_sql(proxy_reflection.options[:finder_sql].gsub(’#{id}’, proxy_owner.id.to_s) + ” LIMIT #{pager.per_page} OFFSET #{pager.offset}”)<br />
    end<br />
  end<br />
end<br />
</code><br />
Finally!</p>

				
				<p class="postmetadata alt">
					<small>
						This entry was posted
												on Wednesday, November 12th, 2008 at 12:03 pm						and is filed under <a href="http://www.32bitkid.com/category/programming/" title="View all posts in Programming" rel="category tag">Programming</a>.
						You can follow any responses to this entry through the <a href='http://www.32bitkid.com/2008/11/12/multiple-foreign-keys-in-rails/feed/'>RSS 2.0</a> feed.

													Responses are currently closed, but you can <a href="http://www.32bitkid.com/2008/11/12/multiple-foreign-keys-in-rails/trackback/ " rel="trackback">trackback</a> from your own site.

						
					</small>
				</p>

			</div>
		</div>

	
<!-- You can start editing here. -->


			<!-- If comments are closed. -->
		<p class="nocomments">Comments are closed.</p>

	


	
	</div>

		<div id="footer">
			<p>Copyright &copy; 2008 Thirty-Two Bit Kid Studios. All rights reserved.</p>
			<p>Comments? Questions? Feedback? Click Here!</p>
			<p>
				<a href="http://www.32bitkid.com/feed/">Entries (RSS)</a>
				and <a href="http://www.32bitkid.com/comments/feed/">Comments (RSS)</a>.
			</p>	
		<!-- 13 queries. 0.667 seconds. -->			
		</div>
</div>

<div id="main-bottom">
	<div id="main-bottom-left"></div>
	<div id="main-bottom-right"></div>		
</div>



</body>
</html>
<!-- Dynamic Page Served (once) in 0.667 seconds -->
